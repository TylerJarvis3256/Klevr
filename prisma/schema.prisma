generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model AiTask {
  id             String       @id @default(cuid())
  user_id        String
  application_id String?
  type           AiTaskType
  status         AiTaskStatus @default(PENDING)
  result_ref     String?
  error_message  String?
  created_at     DateTime     @default(now())
  updated_at     DateTime     @updatedAt
  started_at     DateTime?
  completed_at   DateTime?
  Application    Application? @relation(fields: [application_id], references: [id], onDelete: Cascade)
  User           User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([application_id])
  @@index([created_at])
  @@index([status])
  @@index([type])
  @@index([user_id])
}

model Application {
  id                       String              @id @default(cuid())
  user_id                  String
  job_id                   String
  status                   ApplicationStatus   @default(PLANNED)
  score_count              Int                 @default(1)
  applied_at               DateTime?
  fit_bucket               FitBucket?
  fit_score                Float?
  score_explanation        String?
  matching_skills          String[]
  missing_skills           String[]
  missing_required_skills  String[]            @default([])
  missing_preferred_skills String[]            @default([])
  company_research         Json?
  created_at               DateTime            @default(now())
  updated_at               DateTime            @updatedAt
  AiTask                   AiTask[]
  Job                      Job                 @relation(fields: [job_id], references: [id], onDelete: Cascade)
  User                     User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  GeneratedDocument        GeneratedDocument[]
  Note                     Note[]
  ActivityLog              ActivityLog[]

  @@index([created_at])
  @@index([fit_bucket])
  @@index([job_id])
  @@index([status])
  @@index([user_id])
}

model GeneratedDocument {
  id              String       @id @default(cuid())
  application_id  String
  type            DocumentType
  storage_url     String
  display_name    String?
  structured_data Json?
  prompt_version  String
  model_used      String
  tokens_used     Int?
  deleted_at      DateTime?
  created_at      DateTime     @default(now())
  Application     Application  @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@index([application_id])
  @@index([created_at])
  @@index([type])
}

model Job {
  id                     String        @id @default(cuid())
  user_id                String
  title                  String
  company                String
  location               String?
  job_url                String?
  job_source             JobSource?
  adzuna_id              String?       @unique
  job_description_raw    String
  job_description_parsed Json?
  created_at             DateTime      @default(now())
  updated_at             DateTime      @updatedAt
  Application            Application[]
  User                   User          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([adzuna_id])
  @@index([company])
  @@index([created_at])
  @@index([user_id])
}

model Note {
  id             String      @id @default(cuid())
  application_id String
  content        String
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt
  Application    Application @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@index([application_id])
  @@index([created_at])
}

model Profile {
  id                         String    @id @default(cuid())
  user_id                    String    @unique
  full_name                  String?
  school                     String?
  major                      String?
  graduation_year            Int?
  resume_file_url            String?
  resume_file_name           String?
  resume_uploaded_at         DateTime?
  resume_deleted_at          DateTime?
  parsed_resume              Json?
  parsed_resume_confirmed_at DateTime?
  job_types                  String[]
  preferred_locations        String[]
  skills                     String[]  @default([])
  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt
  User                       User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

model UsageTracking {
  id                 String   @id @default(cuid())
  user_id            String
  month              String
  fit_count          Int      @default(0)
  resume_count       Int      @default(0)
  cover_letter_count Int      @default(0)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  @@unique([user_id, month])
  @@index([month])
  @@index([user_id])
}

model Project {
  id            String   @id @default(cuid())
  user_id       String
  name          String
  description   String?
  technologies  String[] @default([])
  date_range    String?
  url           String?
  github_link   String?
  display_order Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  User          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([display_order])
}

model ActivityLog {
  id             String       @id @default(cuid())
  user_id        String
  application_id String?
  type           ActivityType
  metadata       Json?
  created_at     DateTime     @default(now())
  User           User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  Application    Application? @relation(fields: [application_id], references: [id], onDelete: Cascade)

  @@index([application_id])
  @@index([user_id])
  @@index([type])
  @@index([created_at])
}

model User {
  id           String         @id @default(cuid())
  auth0_id     String         @unique
  email        String         @unique
  created_at   DateTime       @default(now())
  updated_at   DateTime       @updatedAt
  AiTask       AiTask[]
  Application  Application[]
  Job          Job[]
  Profile      Profile?
  Project      Project[]
  ActivityLog  ActivityLog[]
  SavedSearch  SavedSearch[]
  Notification Notification[]

  @@index([auth0_id])
  @@index([email])
}

enum AiTaskStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum AiTaskType {
  JOB_SCORING
  RESUME_GENERATION
  COVER_LETTER_GENERATION
  COMPANY_RESEARCH
}

enum ApplicationStatus {
  PLANNED
  APPLIED
  INTERVIEW
  OFFER
  REJECTED
}

enum DocumentType {
  RESUME
  COVER_LETTER
}

enum FitBucket {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum JobSource {
  LINKEDIN
  INDEED
  GLASSDOOR
  HANDSHAKE
  COMPANY_WEBSITE
  REFERRAL
  ADZUNA
  OTHER
}

enum ActivityType {
  STATUS_CHANGED
  JOB_CREATED
  JOB_SCORING_STARTED
  JOB_SCORING_COMPLETED
  RESUME_GENERATED
  COVER_LETTER_GENERATED
  COMPANY_RESEARCH_COMPLETED
  NOTE_ADDED
  NOTE_EDITED
  DOCUMENT_DELETED
  JOB_DISCOVERED
  SEARCH_PERFORMED
  SEARCH_SAVED
  SAVED_SEARCH_RUN
}

enum SavedSearchFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum NotificationType {
  SAVED_SEARCH_NEW_JOBS
  SYSTEM_ANNOUNCEMENT
}

model SavedSearch {
  id             String               @id @default(cuid())
  user_id        String
  name           String
  query_config   Json
  frequency      SavedSearchFrequency @default(WEEKLY)
  notify_in_app  Boolean              @default(true)
  notify_email   Boolean              @default(true)
  last_run_at    DateTime?
  next_run_at    DateTime?
  user_timezone  String?              @default("America/New_York")
  active         Boolean              @default(true)
  created_at     DateTime             @default(now())
  updated_at     DateTime             @updatedAt
  User           User                 @relation(fields: [user_id], references: [id], onDelete: Cascade)
  SavedSearchRun SavedSearchRun[]

  @@index([user_id])
  @@index([active, next_run_at])
}

model SavedSearchRun {
  id               String      @id @default(cuid())
  saved_search_id  String
  new_jobs_count   Int         @default(0)
  total_jobs_found Int         @default(0)
  adzuna_job_ids   String[]
  status           String
  error_message    String?
  ran_at           DateTime    @default(now())
  SavedSearch      SavedSearch @relation(fields: [saved_search_id], references: [id], onDelete: Cascade)

  @@index([saved_search_id])
  @@index([ran_at])
}

model Notification {
  id         String           @id @default(cuid())
  user_id    String
  type       NotificationType
  title      String
  body       String
  link_url   String?
  read_at    DateTime?
  metadata   Json?
  created_at DateTime         @default(now())
  User       User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, read_at])
}

model AdzunaRequestLog {
  id           String   @id @default(cuid())
  request_type String
  status_code  Int?
  rate_limited Boolean  @default(false)
  created_at   DateTime @default(now())

  @@index([created_at])
  @@index([rate_limited, created_at])
}

model AdzunaSearchCache {
  id         String   @id @default(cuid())
  cache_key  String   @unique
  results    Json
  expires_at DateTime
  created_at DateTime @default(now())

  @@index([cache_key, expires_at])
}
